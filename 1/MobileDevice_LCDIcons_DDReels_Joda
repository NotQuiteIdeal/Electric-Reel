/*
 * ----------------------------------------------------
 * DDReels Mobile Device - LCD Icon Testing
 * Project: Dynamic Drag Reels (D.D. Reels)
 * Author: Gabriel Joda
 * Platform: Raspberry Pi Pico W
 * Purpose: This code tests the icon capabilities of the EA DIP205-6 LCD (RW1073 Controller).
 *          The code executes a sequence to enable the icon display feature and load an icon into SEGRAM.
 *          This version is partially functional but requires additional fine-tuning for full reliability.
 *
 *          Key Features in This Version:
 *            - Implements `lcd_display_icon_example()` to execute the required sequence for displaying an icon.
 *            - Uses RW1073's SEGRAM commands to store and show icons.
 *            - Integrates encoder button control to trigger icon display dynamically.
 *            - Maintains standard LCD functions, including `lcd_print_centered()` and screen clearing.
 *
 *          This version successfully triggers the icon display but requires further refinement for stability.
 *
 * Status: ⚠️ Partially functional (Icons appear inconsistently, requires more testing).
 * ----------------------------------------------------
 */

#include <stdio.h>
#include <string.h>
#include "pico/stdlib.h"
#include "hardware/gpio.h"

// === LCD Pin Definitions === //
// The LCD module (4x20 display) uses a controller similar to the HD44780,
// but our module is built around the RW1073 driver/controller.
#define PIN_RS  17    // Register Select: low = command, high = data.
#define PIN_RW  19    // Read/Write control: low = write.
#define PIN_E   18    // Enable pin: triggers data transfer on falling edge.
#define PIN_RES 20    // Reset pin.

// 8-bit Data Bus for LCD (D0-D7)
const int data_pins[8] = {16, 3, 4, 5, 6, 7, 8, 9};

// Rotary Encoder Button (we use only the integrated push-button)
#define ENCODER_BTN 12  // Encoder push-button (active low).

// --- LCD Helper Functions --- //

// Writes an 8-bit value to the LCD data bus.
void lcd_write_bus(uint8_t data) {
    for (int i = 0; i < 8; i++) {
        gpio_put(data_pins[i], (data >> i) & 1);
    }
}

// Generates an enable pulse per RW1073/HD44780 protocol.
void lcd_pulse_enable() {
    gpio_put(PIN_E, 1);
    sleep_us(200);
    gpio_put(PIN_E, 0);
    sleep_us(200);
}

// Sends a command byte to the LCD.
void lcd_send_command(uint8_t cmd) {
    gpio_put(PIN_RS, 0); // Command mode.
    gpio_put(PIN_RW, 0); // Write mode.
    lcd_write_bus(cmd);
    lcd_pulse_enable();
    sleep_ms(2);
}

// Sends a data byte to the LCD.
void lcd_send_data(uint8_t data) {
    gpio_put(PIN_RS, 1); // Data mode.
    gpio_put(PIN_RW, 0); // Write mode.
    lcd_write_bus(data);
    lcd_pulse_enable();
    sleep_ms(1);
}

// Initializes the LCD module using standard RW1073/HD44780 procedures.
void lcd_init() {
    gpio_put(PIN_RES, 0);
    sleep_ms(50);
    gpio_put(PIN_RES, 1);
    sleep_ms(200);

    lcd_send_command(0x30); // Function set: 8-bit mode.
    sleep_ms(10);
    lcd_send_command(0x06); // Entry mode set: auto-increment.
    sleep_ms(5);
    lcd_send_command(0x36); // Extended function set.
    sleep_ms(10);
    lcd_send_command(0x09); // Icon display on.
    sleep_ms(5);
    lcd_send_command(0x30); // Basic instruction set.
    sleep_ms(10);
    lcd_send_command(0x0C); // Display ON, cursor off.
    sleep_ms(5);
    lcd_send_command(0x01); // Clear display.
    sleep_ms(10);

    printf("[LCD] Initialization Complete!\n");
}

// Prints a string centered on a given line (1 to 4).
void lcd_print_centered(const char *str, uint8_t line) {
    uint8_t start_pos = (20 - strlen(str)) / 2;
    uint8_t ddram_address = (line - 1) * 0x20 + start_pos;
    lcd_send_command(0x80 | ddram_address);
    while (*str) lcd_send_data(*str++);
}

// Displays the main screen.
void display_main_screen() {
    lcd_send_command(0x01);  // Clear display.
    lcd_print_centered("MAIN SCREEN", 1);
    lcd_print_centered("Press Encoder", 2);
    printf("[LCD] Main Screen Displayed.\n");
}

// --- New Function: lcd_display_icon_example --- //
void lcd_display_icon_example(void) {
    lcd_send_command(0x36); // Extended function set.
    lcd_send_command(0x42); // Set SEGRAM command.
    lcd_send_data(0x02);    // Set icon-RAW address to 0x02.
    lcd_send_data(0x10);    // Write data 0x10.
    lcd_send_data(0x10);    // Write data 0x10 again.
    lcd_send_command(0x30); // Function set to 8-bit mode.
    lcd_send_command(0x80); // Set DDRAM address to 0x80.
    printf("[ICON] Icon command sequence executed.\n");
}

// --- GPIO Setup --- //
void gpio_setup(void) {
    int control_pins[] = {PIN_RS, PIN_RW, PIN_E, PIN_RES};
    for (int i = 0; i < 4; i++) {
        gpio_init(control_pins[i]);
        gpio_set_dir(control_pins[i], GPIO_OUT);
    }
    for (int i = 0; i < 8; i++) {
        gpio_init(data_pins[i]);
        gpio_set_dir(data_pins[i], GPIO_OUT);
    }
    gpio_init(ENCODER_BTN);
    gpio_set_dir(ENCODER_BTN, GPIO_IN);
    gpio_pull_up(ENCODER_BTN);
}

int main(void) {
    stdio_init_all();
    sleep_ms(2000);
    gpio_setup();
    lcd_init();
    display_main_screen();

    while (1) {
        if (!gpio_get(ENCODER_BTN)) {
            printf("Encoder button pressed: executing icon sequence.\n");
            lcd_display_icon_example();
            sleep_ms(3000);
            display_main_screen();
        }
        sleep_ms(50);
    }
}
