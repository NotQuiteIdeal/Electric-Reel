#include <stdio.h>
#include "pico/stdlib.h"
#include "hardware/spi.h"

// SPI Pins
#define SPI_PORT spi0
#define PIN_CS   17  // Chip Select
#define PIN_SCLK 18  // Clock
#define PIN_MOSI 19  // Data (SID)
#define PIN_RES  22  // Reset (active low)

// RW1073 Commands
#define CMD_CLEAR       0x01
#define CMD_HOME        0x02
#define CMD_ENTRY_MODE  0x06
#define CMD_DISPLAY_CTL 0x0C
#define CMD_FUNCTION    0x30
#define CMD_EXT_FUNCTION 0x36

// Send a command to the LCD
void lcd_command(uint8_t cmd) {
    gpio_put(PIN_CS, 0);  // Select LCD
    spi_write_blocking(SPI_PORT, &cmd, 1);
    gpio_put(PIN_CS, 1);  // Deselect LCD
    sleep_ms(2);          // Fixed delay instead of Busy Flag
    printf("Command sent: 0x%02X\n", cmd);
}

// Send data to the LCD
void lcd_data(uint8_t data) {
    gpio_put(PIN_CS, 0);  // Select LCD
    uint8_t packet = data | 0x40;  // RS=1 for data
    spi_write_blocking(SPI_PORT, &packet, 1);
    gpio_put(PIN_CS, 1);  // Deselect LCD
    sleep_ms(1);          // Fixed delay instead of Busy Flag
    printf("Data sent: 0x%02X\n", data);
}

// Initialize the LCD
void lcd_init() {
    // Hardware Reset
    gpio_init(PIN_RES);
    gpio_set_dir(PIN_RES, GPIO_OUT);
    gpio_put(PIN_RES, 0);  // Active low reset
    sleep_ms(50);
    gpio_put(PIN_RES, 1);
    sleep_ms(150);  // Wait >100ms after reset

    // SPI Configuration
    spi_init(SPI_PORT, 100000);  // 100kHz clock
    gpio_set_function(PIN_SCLK, GPIO_FUNC_SPI);
    gpio_set_function(PIN_MOSI, GPIO_FUNC_SPI);

    // Initialization Sequence
    lcd_command(0x30);       // 8-bit mode
    sleep_ms(15);
    lcd_command(0x30);       // Repeat
    sleep_ms(5);
    lcd_command(0x30);       // Final init
    sleep_ms(1);
    
    lcd_command(CMD_EXT_FUNCTION | 0x04);  // 4-line mode
    lcd_command(0x09);        // 4-line + icons
    lcd_command(CMD_DISPLAY_CTL | 0x04);  // Display ON
    lcd_command(CMD_CLEAR);
    sleep_ms(5);
    lcd_command(CMD_ENTRY_MODE | 0x02);  // Auto-increment
}

int main() {
    stdio_init_all();
    printf("Initializing LCD...\n");

    // Initialize CS pin
    gpio_init(PIN_CS);
    gpio_set_dir(PIN_CS, GPIO_OUT);
    gpio_put(PIN_CS, 1);  // Deselect LCD by default

    // Initialize LCD
    lcd_init();
    printf("LCD Initialized.\n");

    // Write to all 4 lines
    lcd_command(0x80);  // Line 1
    lcd_data('H'); lcd_data('e'); lcd_data('l'); lcd_data('l'); lcd_data('o');
    
    lcd_command(0xA0);  // Line 2
    lcd_data('W'); lcd_data('o'); lcd_data('r'); lcd_data('l'); lcd_data('d');

    printf("Display updated.\n");

    while(1) tight_loop_contents();
}
